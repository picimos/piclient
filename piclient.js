!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@epicgames-ps/lib-pixelstreamingfrontend-ue5.2"),require("live-cat")):"function"==typeof define&&define.amd?define(["@epicgames-ps/lib-pixelstreamingfrontend-ue5.2","live-cat"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).PiClientJS=t(e.require$$0,e.require$$1)}(this,(function(e,t){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),i=n(t);function s(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var r,l={exports:{}};return s((r||(r=1,function(e,t){!function(e,t){function n(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(e,o[i])&&(n[o[i]]=e[o[i]])}return n}function o(e,t,n,o){function i(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,s){function r(e){try{c(o.next(e))}catch(e){s(e)}}function l(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):i(e.value).then(r,l)}c((o=o.apply(e,t||[])).next())}))}t||(t=window["lib-pixelstreamingfrontend"]);var s="0.3.4";const r="https://app.3dcat.live";function l(t){return o(this,void 0,void 0,(function*(){let n,s,l;const c={},{address:d,appKey:a,$el:u=document.body,readyCB:h,disconnectCB:p,onProgress:f,report:v}=t,m=d.includes(r);let b;const g=()=>{b=setInterval((()=>{null==v||v(n.report())}),1e3)},y=e=>{null==p||p(e),clearInterval(b)},{Launcher:_,LauncherPrivate:w}=yield new Promise((function(t,n){!function(n){"object"==typeof e?t(i.default):(n=n||self,t(n.LiveCat))}(window)})),P=()=>o(this,void 0,void 0,(function*(){try{null==f||f(20),n=new(m?_:w)({baseOptions:{address:d,appKey:a,startType:1},extendOptions:{onPlay:()=>o(this,void 0,void 0,(function*(){return null==f||f(90),v&&g(),s.setVideoVolume(1),yield null==h?void 0:h(),null==f||f(100),{}}))}}),yield n.automata(u),l=n.getConnection(),c.emit=e=>l.emitUIInteraction(e),c.onMessage=l.event.interaction.on,l.event.close.on((()=>{y("连接中断")})),l.event.disconnect.on((()=>{y("信令断开")})),l.event.afk.on((()=>{y("超时断开")})),s=n.getPlayer(),s.showLoadingText("服务启动中···"),null==f||f(30),l.event.connect.on((()=>{s.showLoadingText("服务连接中···"),null==f||f(50)})),l.event.dataChannelConnected.on((()=>{s.showLoadingText("资源加载中···"),null==f||f(70)}))}catch(e){throw new Error("Faild to initialize cloudrender. "+e)}})),O=()=>{clearInterval(b),null==n||n.destory(""),n=null,l=null};return c.init=P,c.destroy=O,c}))}const c=window.console;function d(e,...t){c.log(`%c [PiClientJS] ${e}`,"color:#eb906e",...t)}function a(e,...t){c.log(`%c [PiClientJS Error] ${e}`,"color:red",...t)}function u(e){const t=/([\:\-\_\.]+(.))/g,n=/^moz([A-Z])/;return e.replace(t,((e,t,n,o)=>o?n.toUpperCase():n)).replace(n,"Moz$1")}function h(e){return o(this,void 0,void 0,(function*(){const n={},i=()=>o(this,void 0,void 0,(function*(){try{console.log(t,"libPixelstreamingfrontendUe5_2");const i=new t.Config({initialSettings:{AutoPlayVideo:!0,AutoConnect:!0,ss:e.address,StartVideoMuted:!1,MatchViewportRes:!0,HoveringMouse:!0}}),s=new t.PixelStreaming(i,{videoElementParent:e.$el});n.emit=e=>o(this,void 0,void 0,(function*(){return yield s.emitUIInteraction(JSON.parse(e))}));let r=null;n.onMessage=e=>(r=e,{dispose:()=>{}}),n.destroy=()=>{s.disconnect()},s.addEventListener("playStreamRejected",(()=>{const e=document.getElementById("clickToPlayElement");e&&(e.className="visible",e.onclick=()=>{s.play(),e.className="",e.onclick=()=>{}})})),s.addEventListener("playStream",(()=>{var t;console.log("pixel stream start play....."),null===(t=e.readyCB)||void 0===t||t.call(e)})),s.addResponseEventListener("pistream",(e=>{r(e)})),s.play()}catch(e){throw new Error("Faild to initialize cloudrender. "+e)}}));return n.init=i,n}))}const p={debug:!1},f="__PiClientEvent",v="",m=".once";let b=0;class g{get _ins(){var e;return null===(e=window.ue)||void 0===e?void 0:e.interface}get _inClient(){return!!this._ins}_setBaseDb(e){var t,n,o,i,s;const{params:r}=e||{};this.classes=null!==(t=null==r?void 0:r.classes)&&void 0!==t?t:[],this.classEvents=null!==(n=null==r?void 0:r.classEvents)&&void 0!==n?n:{},this.actions=null!==(o=null==r?void 0:r.actions)&&void 0!==o?o:[],this.globalObjects=null!==(i=null==r?void 0:r.globalObjects)&&void 0!==i?i:[],this.worldObjects=null!==(s=null==r?void 0:r.worldObjects)&&void 0!==s?s:[]}constructor(e=p){this._v=s,this._opts=p,this._cbs={},this._connected=!1,this.classes=[],this.classEvents={},this.actions=[],this.globalObjects=[],this.worldObjects=[],this._cloudrenderIns={},this.cloudrender={address:"",appKey:"",mode:"pixelstreaming",$el:void 0,enabled:!1,destroy:()=>{var e,t,n,o;this.cloudrender.enabled=!1,null===(t=(e=this._cloudrenderIns).destroy)||void 0===t||t.call(e),null===(o=null===(n=this.cloudrender.$el)||void 0===n?void 0:n.firstChild)||void 0===o||o.remove()},init:e=>{if(this._inClient)return Promise.reject("Do not enable cloudrender in the client.");if(!e)return Promise.reject("Missing [options].");const{$el:t,address:i,appKey:s,mode:r,onDisconnect:c,onProgress:d,report:u}=e,p=n(e,["$el","address","appKey","mode","onDisconnect","onProgress","report"]);return this.cloudrender.address=i,this.cloudrender.appKey=s,this.cloudrender.$el=t,this.cloudrender.mode=r,(null==r||""==r||"pixelstreaming"!=r&&"3dcat"!=r)&&(this.cloudrender.mode="embed"),new Promise(((t,n)=>o(this,void 0,void 0,(function*(){const n=()=>(this.cloudrender.enabled=!0,this.emit("cloud.init",p,(e=>{this._setBaseDb(e),t(e.params)})).catch((e=>a("cloudrender init error: "+e)))),o=e=>{this.cloudrender.destroy(),null==c||c(e)};try{const t=e=>{try{const t=JSON.parse(e);this.onMessage(t)}catch(t){a(`onMessage error [${e}]: `,t)}},i="3dcat"==r?l:h,s=yield i(Object.assign(Object.assign({},e),{readyCB:n,disconnectCB:o}));yield s.init(),this._cloudrenderIns=s,s.onMessage(t)}catch(e){const t=(null==e?void 0:e.message)||e;a(t),o(t)}}))))}},d(`version[${this._v}].`),d(`mode ${this.cloudrender.mode}`),"3dcat"==this.cloudrender.mode&&(this._inClient||(this.cloudrender.mode="embed",a("Not in the client of PiCIMOS. switch to embed mode"))),this._opts=Object.assign(p,e)}connect(){return!!this._inClient&&(window.ue.interface[f]=e=>this.onMessage.call(this,e),this._connected=!0,!0)}onMessage(e){const{action:t,target:n,params:o}=e||{},i=this._cbs[t],s=n||v,r=this._cbs.global[v];if(r&&r.forEach((t=>t(e))),this._opts.debug&&d(`👉onMessage event[${t}]: ${n||"unknow target"}`,o,i?"":"no action callback"),!i)return;const l=i[s];if(l&&l.forEach((t=>t(e))),s!==v){const t=i[v];t&&t.forEach((t=>t(e)))}const c=i[s+m];c&&c.forEach((t=>t(e)))}on(e,t,n){e&&n&&(t=t||v,this._cbs[e]||(this._cbs[e]={}),this._cbs[e][t]||(this._cbs[e][t]=[]),this._cbs[e][t].push(n))}off(e,t){if(!e)return!1;const n="$$";return(t=(null!=t?t:n)||v)===n?delete this._cbs[e]:!!this._cbs[e]&&delete this._cbs[e][t]}once(e,t,n){const o=(t||v)+m;this.on(e,o,(t=>{this.off(e,o),n(t)}))}emit(e,t,n){if("3dcat"==this.cloudrender.mode&&!this._inClient&&!this.cloudrender.enabled)return void a("Not in the client of PiCIMOS. Nor cloudrender enabled.");const{target:o}=t||{},i=o||v;this._opts.debug&&d(`👆emit event[${e}]: ${o||"unknow target"}`,t);const s={action:e,target:i,params:t};if(n&&"function"==typeof n){const t=u(`${e}.cb${++b}`);s.callbackAction=t,this.once(t,"",n)}return new Promise(((t,n)=>{this.once(e,i,(e=>{!1!==e.success?t(e):n(e.msg||"unknown client error.")}));const o=JSON.stringify(s);d(`msg to send [${o}]`),"embed"==this.cloudrender.mode?this._ins.broadcast("mode.event",o):"3dcat"==this.cloudrender.mode?this._cloudrenderIns.emit(encodeURIComponent(o)):"pixelstreaming"==this.cloudrender.mode&&this._cloudrenderIns.emit(o)}))}pageReady(){var e;return this._connected||this.connect(),null===(e=this.emit("page.loadCompleted"))||void 0===e?void 0:e.then((e=>(this._setBaseDb(e),e.params)))}}e.PiClient=g,Object.defineProperty(e,"__esModule",{value:!0})}(t,o.default)}(0,l.exports)),l.exports))}));
