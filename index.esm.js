function e(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{l(s.next(e))}catch(e){i(e)}}function c(e){try{l(s.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}l((s=s.apply(e,t||[])).next())}))}function t(t){return e(this,void 0,void 0,(function*(){let n,s,o;const i={},{address:r,appKey:c,$el:l=document.body,readyCB:a,disconnectCB:d,onProgress:h,report:u}=t,p=r.includes("https://app.3dcat.live");let b;const v=e=>{null==d||d(e),clearInterval(b)},{Launcher:f,LauncherPrivate:g}=yield import("live-cat");return i.init=()=>e(this,void 0,void 0,(function*(){try{null==h||h(20),n=new(p?f:g)({baseOptions:{address:r,appKey:c,startType:1},extendOptions:{onPlay:()=>(u&&(b=setInterval((()=>{null==u||u(n.report())}),1e3)),s.setVideoVolume(1),null==a||a(),null==h||h(100),{})}}),yield n.automata(l),o=n.getConnection(),i.emit=e=>o.emitUIInteraction(e),i.onMessage=o.event.interaction.on,o.event.close.on((()=>{v("è¿žæŽ¥ä¸­æ–­")})),o.event.disconnect.on((()=>{v("ä¿¡ä»¤æ–­å¼€")})),o.event.afk.on((()=>{v("è¶…æ—¶æ–­å¼€")})),s=n.getPlayer(),s.showLoadingText("æœåŠ¡å¯åŠ¨ä¸­Â·Â·Â·"),null==h||h(30),o.event.connect.on((()=>{s.showLoadingText("æœåŠ¡è¿žæŽ¥ä¸­Â·Â·Â·"),null==h||h(50)})),o.event.dataChannelConnected.on((()=>{s.showLoadingText("èµ„æºåŠ è½½ä¸­Â·Â·Â·"),null==h||h(70)}))}catch(e){throw new Error("Faild to initialize cloudrender."+e)}})),i.destroy=()=>{clearInterval(b),null==n||n.destory(""),n=null,o=null},i}))}const n=window.console;function s(e,...t){n.log(`%c [PiClientJS] ${e}`,"color:#eb906e",...t)}function o(e,...t){n.log(`%c [PiClientJS Error] ${e}`,"color:red",...t)}const i={debug:!1};let r=0;class c{constructor(n=i){this._v="0.3.4",this._opts=i,this._cbs={},this._connected=!1,this.classes=[],this.classEvents={},this.actions=[],this.globalObjects=[],this.worldObjects=[],this._cloudrenderIns={},this.cloudrender={address:"",appKey:"",$el:void 0,enabled:!1,destroy:()=>{var e,t,n,s;this.cloudrender.enabled=!1,null===(t=(e=this._cloudrenderIns).destroy)||void 0===t||t.call(e),null===(s=null===(n=this.cloudrender.$el)||void 0===n?void 0:n.firstChild)||void 0===s||s.remove()},init:n=>{if(this._inClient)return Promise.reject("Do not enable cloudrender in the client.");if(!n)return Promise.reject("Missing [options].");const{$el:s,address:i,appKey:r,onProgress:c,report:l}=n,a=function(e,t){var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n}(n,["$el","address","appKey","onProgress","report"]);return i&&r?(this.cloudrender.address=i,this.cloudrender.appKey=r,this.cloudrender.$el=s,new Promise(((s,i)=>e(this,void 0,void 0,(function*(){const e=i,r=yield t(Object.assign(Object.assign({},n),{readyCB:()=>{this.cloudrender.enabled=!0,this.emit("cloud.init",a,(e=>{this._setBaseDb(e),s(e.params)})).catch((e=>o("cloudrender init error: "+e)))},disconnectCB:t=>{this.cloudrender.destroy(),e(t)}}));yield r.init(),this._cloudrenderIns=r,r.onMessage((e=>{try{const t=JSON.parse(e);this.onMessage(t)}catch(t){o(`onMessage error [${e}]: `,t)}}))}))))):Promise.reject("Missing required parameters: address, appKey.")}},s(`version[${this._v}].`),this._inClient||o("Not in the client of PiCIMOS."),this._opts=Object.assign(i,n)}get _ins(){var e;return null===(e=window.ue)||void 0===e?void 0:e.interface}get _inClient(){return!!this._ins}_setBaseDb(e){const{params:t}=e||{};this.classes=t.classes,this.classEvents=t.classEvents,this.actions=t.actions,this.globalObjects=t.globalObjects,this.worldObjects=t.worldObjects}connect(){return!!this._inClient&&(window.ue.interface.__PiClientEvent=e=>this.onMessage.call(this,e),this._connected=!0,!0)}onMessage(e){const{action:t,target:n,params:o}=e||{},i=this._cbs[t];if(this._opts.debug&&s(`ðŸ‘‰onMessage event[${t}]: ${n||"unknow target"}`,o,i?"":"no action callback"),!i)return;const r=n||"",c=i[r];if(c&&c.forEach((t=>t(e))),""!==r){const t=i[""];t&&t.forEach((t=>t(e)))}const l=i[r+".once"];l&&l.forEach((t=>t(e)))}on(e,t,n){e&&n&&(t=t||"",this._cbs[e]||(this._cbs[e]={}),this._cbs[e][t]||(this._cbs[e][t]=[]),this._cbs[e][t].push(n))}off(e,t){if(!e)return!1;return"$$"===(t=(null!=t?t:"$$")||"")?delete this._cbs[e]:!!this._cbs[e]&&delete this._cbs[e][t]}once(e,t,n){const s=(t||"")+".once";this.on(e,s,(t=>{this.off(e,s),n(t)}))}emit(e,t,n){if(!this._inClient&&!this.cloudrender.enabled)return void o("Not in the client of PiCIMOS. Nor cloudrender enabled.");const{target:i}=t||{},c=i||"";this._opts.debug&&s(`ðŸ‘†emit event[${e}]: ${i||"unknow target"}`,t);const l={action:e,target:c,params:t};if(n&&"function"==typeof n){const t=`${e}.cb${++r}`.replace(/([\:\-\_\.]+(.))/g,((e,t,n,s)=>s?n.toUpperCase():n)).replace(/^moz([A-Z])/,"Moz$1");l.callbackAction=t,this.once(t,"",n)}return new Promise(((t,n)=>{this.once(e,c,(e=>{!1!==e.success?t(e):n(e.msg||"unknown client error.")}));const s=JSON.stringify(l);!this._inClient&&this.cloudrender.enabled?this._cloudrenderIns.emit(encodeURIComponent(s)):this._ins.broadcast("mode.event",s)}))}pageReady(){var e;return this._connected||this.connect(),null===(e=this.emit("page.loadCompleted"))||void 0===e?void 0:e.then((e=>(this._setBaseDb(e),e.params)))}}export{c as PiClient};
