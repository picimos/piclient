!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).PiClientJS={})}(this,(function(e){"use strict";function t(e,t,n,o){return new(n||(n=Promise))((function(s,i){function r(e){try{l(o.next(e))}catch(e){i(e)}}function c(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}l((o=o.apply(e,t||[])).next())}))}function n(n){return t(this,void 0,void 0,(function*(){let o,s,i;const r={},{address:c,appKey:l,$el:a=document.body,readyCB:d,disconnectCB:u,onProgress:h,report:p}=n,f=c.includes("https://app.3dcat.live");let v;const b=e=>{null==u||u(e),clearInterval(v)},{Launcher:y,LauncherPrivate:g}=yield new Promise((function(t,n){var o;o=window,"object"==typeof e&&"undefined"!=typeof module?t(require("live-cat")):"function"==typeof define&&define.amd?require(["live-cat"],t,n):(o=o||self,t(o.LiveCat))}));return r.init=()=>t(this,void 0,void 0,(function*(){try{null==h||h(20),o=new(f?y:g)({baseOptions:{address:c,appKey:l,startType:1},extendOptions:{onPlay:()=>t(this,void 0,void 0,(function*(){return null==h||h(90),p&&(v=setInterval((()=>{null==p||p(o.report())}),1e3)),s.setVideoVolume(1),yield null==d?void 0:d(),null==h||h(100),{}}))}}),yield o.automata(a),i=o.getConnection(),r.emit=e=>i.emitUIInteraction(e),r.onMessage=i.event.interaction.on,i.event.close.on((()=>{b("连接中断")})),i.event.disconnect.on((()=>{b("信令断开")})),i.event.afk.on((()=>{b("超时断开")})),s=o.getPlayer(),s.showLoadingText("服务启动中···"),null==h||h(30),i.event.connect.on((()=>{s.showLoadingText("服务连接中···"),null==h||h(50)})),i.event.dataChannelConnected.on((()=>{s.showLoadingText("资源加载中···"),null==h||h(70)}))}catch(e){throw new Error("Faild to initialize cloudrender. "+e)}})),r.destroy=()=>{clearInterval(v),null==o||o.destory(""),o=null,i=null},r}))}const o=window.console;function s(e,...t){o.log(`%c [PiClientJS] ${e}`,"color:#eb906e",...t)}function i(e,...t){o.log(`%c [PiClientJS Error] ${e}`,"color:red",...t)}const r={debug:!1},c="",l=".once";let a=0;e.PiClient=class{constructor(e=r){this._v="0.3.4",this._opts=r,this._cbs={},this._connected=!1,this.classes=[],this.classEvents={},this.actions=[],this.globalObjects=[],this.worldObjects=[],this._cloudrenderIns={},this.cloudrender={address:"",appKey:"",$el:void 0,enabled:!1,destroy:()=>{var e,t,n,o;this.cloudrender.enabled=!1,null===(t=(e=this._cloudrenderIns).destroy)||void 0===t||t.call(e),null===(o=null===(n=this.cloudrender.$el)||void 0===n?void 0:n.firstChild)||void 0===o||o.remove()},init:e=>{if(this._inClient)return Promise.reject("Do not enable cloudrender in the client.");if(!e)return Promise.reject("Missing [options].");const{$el:o,address:s,appKey:r,onDisconnect:c,onProgress:l,report:a}=e,d=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(o=Object.getOwnPropertySymbols(e);s<o.length;s++)t.indexOf(o[s])<0&&Object.prototype.propertyIsEnumerable.call(e,o[s])&&(n[o[s]]=e[o[s]])}return n}(e,["$el","address","appKey","onDisconnect","onProgress","report"]);return s&&r?(this.cloudrender.address=s,this.cloudrender.appKey=r,this.cloudrender.$el=o,new Promise(((o,s)=>t(this,void 0,void 0,(function*(){const t=()=>(this.cloudrender.enabled=!0,this.emit("cloud.init",d,(e=>{this._setBaseDb(e),o(e.params)})).catch((e=>i("cloudrender init error: "+e)))),s=e=>{this.cloudrender.destroy(),null==c||c(e)};try{const o=e=>{try{const t=JSON.parse(e);this.onMessage(t)}catch(t){i(`onMessage error [${e}]: `,t)}},r=yield n(Object.assign(Object.assign({},e),{readyCB:t,disconnectCB:s}));yield r.init(),this._cloudrenderIns=r,r.onMessage(o)}catch(e){const t=(null==e?void 0:e.message)||e;i(t),s(t)}}))))):Promise.reject("Missing required parameters: address, appKey.")}},s(`version[${this._v}].`),this._inClient||i("Not in the client of PiCIMOS."),this._opts=Object.assign(r,e)}get _ins(){var e;return null===(e=window.ue)||void 0===e?void 0:e.interface}get _inClient(){return!!this._ins}_setBaseDb(e){const{params:t}=e||{};this.classes=t.classes,this.classEvents=t.classEvents,this.actions=t.actions,this.globalObjects=t.globalObjects,this.worldObjects=t.worldObjects}connect(){return!!this._inClient&&(window.ue.interface.__PiClientEvent=e=>this.onMessage.call(this,e),this._connected=!0,!0)}onMessage(e){const{action:t,target:n,params:o}=e||{},i=this._cbs[t];if(this._opts.debug&&s(`👉onMessage event[${t}]: ${n||"unknow target"}`,o,i?"":"no action callback"),!i)return;const r=n||c,a=i[r];if(a&&a.forEach((t=>t(e))),r!==c){const t=i[""];t&&t.forEach((t=>t(e)))}const d=i[r+l];d&&d.forEach((t=>t(e)))}on(e,t,n){e&&n&&(t=t||c,this._cbs[e]||(this._cbs[e]={}),this._cbs[e][t]||(this._cbs[e][t]=[]),this._cbs[e][t].push(n))}off(e,t){if(!e)return!1;return"$$"===(t=(null!=t?t:"$$")||c)?delete this._cbs[e]:!!this._cbs[e]&&delete this._cbs[e][t]}once(e,t,n){const o=(t||c)+l;this.on(e,o,(t=>{this.off(e,o),n(t)}))}emit(e,t,n){if(!this._inClient&&!this.cloudrender.enabled)return void i("Not in the client of PiCIMOS. Nor cloudrender enabled.");const{target:o}=t||{},r=o||c;this._opts.debug&&s(`👆emit event[${e}]: ${o||"unknow target"}`,t);const l={action:e,target:r,params:t};if(n&&"function"==typeof n){const t=`${e}.cb${++a}`.replace(/([\:\-\_\.]+(.))/g,((e,t,n,o)=>o?n.toUpperCase():n)).replace(/^moz([A-Z])/,"Moz$1");l.callbackAction=t,this.once(t,"",n)}return new Promise(((t,n)=>{this.once(e,r,(e=>{!1!==e.success?t(e):n(e.msg||"unknown client error.")}));const o=JSON.stringify(l);!this._inClient&&this.cloudrender.enabled?this._cloudrenderIns.emit(encodeURIComponent(o)):this._ins.broadcast("mode.event",o)}))}pageReady(){var e;return this._connected||this.connect(),null===(e=this.emit("page.loadCompleted"))||void 0===e?void 0:e.then((e=>(this._setBaseDb(e),e.params)))}},Object.defineProperty(e,"__esModule",{value:!0})}));
